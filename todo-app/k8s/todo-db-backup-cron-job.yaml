apiVersion: batch/v1
kind: CronJob
metadata:
  name: todo-db-backup
  namespace: project
spec:
  schedule: "0 0 * * *"   # once every 24 hours (midnight UTC)
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3

  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure

          containers:
          - name: backup
            image: google/cloud-sdk:slim
            env:
            - name: PGHOST
              value: todo-postgres
            - name: PGUSER
              value: todo
            - name: PGDATABASE
              value: todo
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: todo-db-secret
                  key: password
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /secrets/key.json

            command:
            - /bin/sh
            - -c
            - |
              set -e
              TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
              FILE="/tmp/todo-db-$TIMESTAMP.sql"

              echo "Creating database backup..."
              pg_dump > $FILE

              echo "Uploading backup to GCS..."
              gsutil cp $FILE gs://todo-db-backups-<PROJECT_ID>/

              echo "Backup completed successfully"

            volumeMounts:
            - name: gcs-key
              mountPath: /secrets
              readOnly: true

          volumes:
          - name: gcs-key
            secret:
              secretName: gcs-backup-key
