# Existing PersistentVolumeClaim (Unchanged)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: image-pvc
spec:
  storageClassName: local-path
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
# Existing PersistentVolume (Unchanged)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: image-pv
spec:
  storageClassName: local-path
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  local:
    path: /tmp/kube
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - k3d-k3s-default-server-0
  persistentVolumeReclaimPolicy: Retain
---
# 1. Frontend Deployment (Updated with new image name and labels)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-deployment # Keeping original deployment name
spec:
  replicas: 1
  selector:
    matchLabels:
      app: todo-frontend # NEW Label
  template:
    metadata:
      labels:
        app: todo-frontend # NEW Label
    spec:
      containers:
        - name: todo-frontend
          image: haydar26/todo-frontend:latest # Use the new frontend image
          ports:
            - containerPort: 3000
          env:
            - name: PORT
              value: "3000"
          volumeMounts:
            - name: image-storage
              mountPath: /app/data 
      volumes:
        - name: image-storage
          persistentVolumeClaim:
            claimName: image-pvc
---
# 2. Frontend Service (Updated with new selector)
apiVersion: v1
kind: Service
metadata:
  name: todo-service # Keeping original service name
spec:
  selector:
    app: todo-frontend # Selector matches the updated Deployment label
  type: NodePort
  ports:
    - protocol: TCP
      port: 80
      targetPort: 3000
      nodePort: 30080
---
# 3. Todo Backend Deployment (NEW)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todo-backend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: todo-backend
  template:
    metadata:
      labels:
        app: todo-backend
    spec:
      containers:
        - name: todo-backend
          image: haydar26/todo-backend:latest # New backend image
          ports:
            - containerPort: 3001 # Backend listens on 3001
          env:
            - name: PORT
              value: "3001"
---
# 4. Todo Backend Service (NEW)
apiVersion: v1
kind: Service
metadata:
  name: todo-backend-service # CRITICAL: Used for internal DNS resolution by the frontend
spec:
  selector:
    app: todo-backend
  type: ClusterIP 
  ports:
    - protocol: TCP
      port: 3001        # ClusterIP port
      targetPort: 3001  # Container port